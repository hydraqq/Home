// server.js - –°–µ—Ä–≤–µ—Ä —Å Supabase –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
const express = require('express');
const WebSocket = require('ws');
const path = require('path');
const { createClient } = require('@supabase/supabase-js');

const app = express();
const PORT = process.env.PORT || 3000;

// Supabase –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏!
const supabaseUrl = process.env.SUPABASE_URL || 'https://your-project.supabase.co';
const supabaseKey = process.env.SUPABASE_KEY || 'your-anon-key';
const supabase = createClient(supabaseUrl, supabaseKey);

// –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
let menuCache = { 
    menu: [], 
    wallet: { kisses: 10, massage: 5, scratches: 2, dishes: 1 },
    lastUpdated: new Date().toISOString() 
};

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Express
app.use(express.static(__dirname));
app.use(express.json({ limit: '10mb' })); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Supabase –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
async function loadFromDatabase() {
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–ª—é–¥–∞
        const { data: menuData, error: menuError } = await supabase
            .from('menu_items')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (menuError) throw menuError;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—à–µ–ª–µ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ wallet)
        let walletData = { kisses: 10, massage: 5, scratches: 2, dishes: 1 };
        
        try {
            const { data: wallet, error: walletError } = await supabase
                .from('wallet')
                .select('*')
                .eq('id', 1)
                .single();
            
            if (wallet && !walletError) {
                // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                if (wallet.licks !== undefined) {
                    wallet.dishes = wallet.licks;
                    delete wallet.licks;
                }
                walletData = wallet;
            }
        } catch (e) {
            // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            console.log('–¢–∞–±–ª–∏—Ü–∞ wallet –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –º–µ–Ω—é
        if (menuData) {
            menuData.forEach(item => {
                // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ —Ü–µ–Ω
                if (item.kissPrice && !item.prices) {
                    item.prices = {
                        kisses: item.kissPrice,
                        massage: 0,
                        scratches: 0,
                        dishes: 0
                    };
                    delete item.kissPrice;
                }
                
                // –ú–∏–≥—Ä–∞—Ü–∏—è licks –≤ dishes
                if (item.prices && item.prices.licks !== undefined) {
                    item.prices.dishes = item.prices.licks;
                    delete item.prices.licks;
                }
            });
        }
        
        menuCache = {
            menu: menuData || [],
            wallet: walletData,
            lastUpdated: new Date().toISOString()
        };
        
        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${(menuData || []).length} –±–ª—é–¥ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö`);
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –ë–î:', error);
    }
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
loadFromDatabase();

// API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
app.get('/api/menu', async (req, res) => {
    res.json(menuCache);
});

// API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
app.post('/api/menu', async (req, res) => {
    try {
        const newData = req.body;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ—à–µ–ª–µ–∫ –æ—Ç–¥–µ–ª—å–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if (newData.wallet) {
            try {
                // –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                if (newData.wallet.licks !== undefined) {
                    newData.wallet.dishes = newData.wallet.licks;
                    delete newData.wallet.licks;
                }
                
                // –ü—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ—à–µ–ª–µ–∫
                const { error: updateError } = await supabase
                    .from('wallet')
                    .update(newData.wallet)
                    .eq('id', 1);
                
                if (updateError) {
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                    const { error: insertError } = await supabase
                        .from('wallet')
                        .insert([{ id: 1, ...newData.wallet }]);
                    
                    if (insertError && insertError.code !== '23505') {
                        console.log('–¢–∞–±–ª–∏—Ü–∞ wallet –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞:', insertError);
                    }
                }
            } catch (e) {
                console.log('–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞:', e.message);
            }
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–æ–±–∞–≤–∏—Ç—å, –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å
        const currentIds = menuCache.menu.map(item => item.id);
        const newIds = newData.menu.map(item => item.id);
        
        // –£–¥–∞–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ
        const toDelete = currentIds.filter(id => !newIds.includes(id));
        if (toDelete.length > 0) {
            const { error } = await supabase
                .from('menu_items')
                .delete()
                .in('id', toDelete);
            
            if (error) throw error;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
        for (const item of newData.menu) {
            const { id, ...itemData } = item;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –≤ –Ω–æ–≤—ã–π
            if (itemData.kissPrice && !itemData.prices) {
                itemData.prices = {
                    kisses: itemData.kissPrice,
                    massage: 0,
                    scratches: 0,
                    dishes: 0
                };
                delete itemData.kissPrice;
            }
            
            // –ú–∏–≥—Ä–∞—Ü–∏—è licks –≤ dishes
            if (itemData.prices && itemData.prices.licks !== undefined) {
                itemData.prices.dishes = itemData.prices.licks;
                delete itemData.prices.licks;
            }
            
            if (currentIds.includes(id)) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
                const { error } = await supabase
                    .from('menu_items')
                    .update(itemData)
                    .eq('id', id);
                
                if (error) throw error;
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
                const { error } = await supabase
                    .from('menu_items')
                    .insert([{ id, ...itemData }]);
                
                if (error) throw error;
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
        menuCache = {
            menu: newData.menu,
            wallet: newData.wallet || menuCache.wallet,
            lastUpdated: new Date().toISOString()
        };
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
        broadcast({
            type: 'update',
            data: menuCache
        });
        
        res.json({ success: true });
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        res.status(500).json({ error: error.message });
    }
});

// –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
app.get('/health', (req, res) => {
    res.json({ 
        status: 'ok', 
        uptime: process.uptime(),
        itemsCount: menuCache.menu.length,
        lastUpdated: menuCache.lastUpdated,
        database: supabaseUrl !== 'https://your-project.supabase.co' ? 'connected' : 'not configured'
    });
});

// –ó–∞–ø—É—Å–∫ HTTP —Å–µ—Ä–≤–µ—Ä–∞
const server = app.listen(PORT, () => {
    console.log(`
üç≥ –°–µ—Ä–≤–µ—Ä –º–µ–Ω—é –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT}!

${process.env.RENDER ? '‚òÅÔ∏è  –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Render.com' : 'üíª –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º'}
üóÑÔ∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${supabaseUrl !== 'https://your-project.supabase.co' ? 'Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω' : '–ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'}
    `);
});

// WebSocket —Å–µ—Ä–≤–µ—Ä
const wss = new WebSocket.Server({ server });
const clients = new Set();

function broadcast(message) {
    const messageStr = JSON.stringify(message);
    clients.forEach(client => {
        if (client.readyState === WebSocket.OPEN) {
            client.send(messageStr);
        }
    });
}

wss.on('connection', (ws) => {
    clients.add(ws);
    console.log('‚úÖ –ù–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ. –í—Å–µ–≥–æ:', clients.size);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    ws.send(JSON.stringify({
        type: 'init',
        data: menuCache
    }));
    
    // –ü–∏–Ω–≥ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    const pingInterval = setInterval(() => {
        if (ws.readyState === WebSocket.OPEN) {
            ws.ping();
        }
    }, 30000);
    
    ws.on('close', () => {
        clients.delete(ws);
        clearInterval(pingInterval);
        console.log('‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ. –û—Å—Ç–∞–ª–æ—Å—å:', clients.size);
    });
    
    ws.on('error', (error) => {
        console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
        clients.delete(ws);
        clearInterval(pingInterval);
    });
});

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç Supabase
if (supabaseUrl !== 'https://your-project.supabase.co') {
    const subscription = supabase
        .channel('menu_changes')
        .on('postgres_changes', 
            { 
                event: '*', 
                schema: 'public', 
                table: 'menu_items' 
            }, 
            async (payload) => {
                console.log('üì° –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –ë–î:', payload.eventType);
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                await loadFromDatabase();
                broadcast({
                    type: 'update',
                    data: menuCache
                });
            }
        )
        .subscribe();
}
